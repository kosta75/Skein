<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.skein.model.dao.BoardDao">

	<!-- 1. 그룹 등록 -->
	<insert id="groupReg" parameterType="kr.co.skein.model.vo.BoardCommand">
		<selectKey keyProperty="groupSeq" resultType="Integer">
			SELECT NVL(MAX(GroupSeq)+1,1) FROM BoardGroup
		</selectKey>
		INSERT INTO BoardGroup(GroupSeq, GroupName, IsImportantGroup, GroupStartDate, GroupEndDate)
		VALUES(#{groupSeq}, #{groupName}, #{isImportantGroup}, #{groupStartDate}, #{groupEndDate})
	</insert>
	
	<!-- 1.1. 공통 게시물 시퀀스 뽑아내기 -->
	<select id="getGroupMaxSequence" resultType="Integer">
		SELECT NVL(MAX(GroupSeq)+1,1) FROM BoardGroup
	</select>
	
	<!-- 2. 공통 게시물 등록 -->
	<insert id="boardReg" parameterType="kr.co.skein.model.vo.BoardCommand">
		<selectKey keyProperty="boardSeq" resultType="Integer">
			SELECT NVL(MAX(BoardSeq)+1,1) FROM Board 
		</selectKey>
		INSERT INTO Board(BoardSeq, BoardKindSeq, Email, Content, WriteDate, PublicLevelCode, IsActivated, GroupSeq)
		VALUES(#{boardSeq}, #{boardKindSeq}, #{email}, #{content}, SYSDATE, #{publicLevelCode}, #{isActivated}, #{groupSeq})
	</insert>
	
	<!-- 2. 공통 게시물 시퀀스 뽑아내기 -->
	<select id="getBoardMaxSequence" resultType="Integer">
		SELECT NVL(MAX(BoardSeq)+1,1) FROM Board
	</select>
	
	<!-- 3. History 게시물 등록 -->
	<insert id="historyReg" parameterType="kr.co.skein.model.vo.HistoryCommand">
		<selectKey keyProperty="historySeq" resultType="Integer">
			SELECT NVL(MAX(HistorySeq)+1,1) FROM History
		</selectKey>
		INSERT INTO History(HistorySeq, BoardSeq, StartDate, EndDate, Feelings, Weather, IsImportant, IsShare, Keyword, Place)
		VALUES(#{historySeq}, #{boardSeq}, #{startDate}, #{endDate}, #{feelings}, #{weather}, #{isImportant}, #{isShare}, #{keyword}, #{place})
	</insert>
	
	<!-- 3.1 공통 게시물 시퀀스 뽑아내기 -->
	<select id="getHistoryMaxSequence" resultType="Integer">
		SELECT NVL(MAX(HistorySeq)+1,1) FROM History
	</select>
	
	<!-- 4. 미디어 파일 등록 -->
	<insert id="mediaReg" parameterType="kr.co.skein.model.vo.Media">
		<selectKey keyProperty="mediaSeq" resultType="Integer">
			SELECT NVL(MAX(MediaSeq)+1,1) FROM Media
		</selectKey>
		INSERT INTO Media(MediaSeq, BoardSeq, FileName, FileSize, Extension)
		VALUES(#{mediaSeq}, #{boardSeq}, #{fileName}, #{fileSize}, #{extension})
	</insert>
	
	<!-- 4.1 공통 게시물 시퀀스 뽑아내기 -->
	<select id="getMediaMaxSequence" resultType="Integer">
		SELECT NVL(MAX(MediaSeq)+1,1) FROM Media
	</select>
	
	<!-- 5. 사용자 게시물 조회 -->
	<select id="getBoards" resultType="kr.co.skein.model.vo.MemberBoardCommand">
		SELECT m.EMAIL, m.FULLNAME, m.BIRTHDAY, m.PERSONALURI, b.BOARDSEQ, b.BOARDKINDSEQ, b.CONTENT, b.WRITEDATE, b.PUBLICLEVELCODE, b.ISACTIVATED, b.GROUPSEQ,
			h.HISTORYSEQ, h.STARTDATE, h.ENDDATE, h.FEELINGS, h.WEATHER, h.ISIMPORTANT, h.ISSHARE, h.KEYWORD, h.PLACE, bg.GROUPNAME, bg.ISIMPORTANTGROUP, bg.GROUPSTARTDATE, bg.GROUPENDDATE,
			me.MEDIASEQ, me.FILENAME, me.FILESIZE, me.EXTENSION
			FROM MEMBERS m JOIN BOARD b ON m.EMAIL = b.email
				JOIN BOARDGROUP bg ON b.GROUPSEQ = bg.GROUPSEQ
				JOIN HISTORY h ON b.BOARDSEQ = h.BOARDSEQ
				LEFT OUTER JOIN MEDIA me ON b.BOARDSEQ = me.BOARDSEQ




				WHERE m.PERSONALURI = #{personalURI} ORDER BY b.GROUPSEQ DESC, b.BOARDSEQ DESC 
	</select>
	
</mapper>